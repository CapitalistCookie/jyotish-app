openapi: 3.0.3
info:
  title: Jyotish API
  description: |
    Vedic Astrology API for birth chart calculation and AI-powered readings.

    ## Authentication
    Most endpoints require JWT authentication. Include the token in the Authorization header:
    ```
    Authorization: Bearer <token>
    ```

    ## Rate Limiting
    API requests are rate limited. Check response headers for limit information.
  version: 1.0.0
  contact:
    name: Jyotish Support
  license:
    name: MIT

servers:
  - url: /
    description: Current server (relative URL)
  - url: http://localhost:3001
    description: Local development
  - url: http://192.168.1.225:3001
    description: LAN development

tags:
  - name: Auth
    description: Authentication endpoints
  - name: Chart
    description: Birth chart generation and retrieval
  - name: Reading
    description: AI-powered astrological readings
  - name: AI
    description: AI provider management
  - name: Subscription
    description: Subscription management
  - name: Affiliate
    description: Affiliate program management
  - name: Admin
    description: Admin panel endpoints (requires admin role)

paths:
  /health:
    get:
      summary: Health check
      operationId: healthCheck
      tags: []
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok
                  timestamp:
                    type: string
                    format: date-time
                  service:
                    type: string
                    example: jyotish-backend

  /api/auth/register:
    post:
      summary: Register a new user
      operationId: registerUser
      tags:
        - Auth
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
      responses:
        '201':
          description: User registered successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '400':
          description: Invalid request data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: Email already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/auth/login:
    post:
      summary: Login user
      operationId: loginUser
      tags:
        - Auth
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/auth/me:
    get:
      summary: Get current user
      operationId: getCurrentUser
      tags:
        - Auth
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Current user info
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserResponse'
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/chart/generate:
    post:
      summary: Generate a birth chart
      operationId: generateChart
      tags:
        - Chart
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChartRequest'
      responses:
        '200':
          description: Chart generated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChartResponse'
        '400':
          description: Invalid birth details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/chart/{id}:
    get:
      summary: Get a saved chart
      operationId: getChart
      tags:
        - Chart
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Chart ID
      responses:
        '200':
          description: Chart retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChartResponse'
        '404':
          description: Chart not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/chart/test/calculate:
    get:
      summary: Test chart calculation
      operationId: testCalculation
      tags:
        - Chart
      responses:
        '200':
          description: Test calculation successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  chart:
                    $ref: '#/components/schemas/BirthChart'

  /api/reading/categories:
    get:
      summary: Get available reading categories
      operationId: getReadingCategories
      tags:
        - Reading
      parameters:
        - name: userId
          in: query
          required: false
          schema:
            type: string
          description: User ID to check access levels
      responses:
        '200':
          description: List of available categories
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CategoriesResponse'

  /api/reading/questions/remaining:
    get:
      summary: Get remaining questions for a user
      operationId: getRemainingQuestions
      tags:
        - Reading
      parameters:
        - name: userId
          in: query
          required: false
          schema:
            type: string
          description: User ID (optional, defaults to anonymous)
      responses:
        '200':
          description: Question quota information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QuestionQuotaResponse'

  /api/reading/{chartId}/summary:
    get:
      summary: Get AI-generated summary reading
      operationId: getSummaryReading
      tags:
        - Reading
      parameters:
        - name: chartId
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Chart ID
        - name: provider
          in: query
          required: false
          schema:
            type: string
            enum: [claude, deepseek, gemini, openai]
          description: Preferred AI provider (optional, uses configured default if not specified)
      responses:
        '200':
          description: Summary reading generated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReadingResponse'
        '404':
          description: Chart not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '503':
          description: AI service unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/reading/{chartId}/{category}:
    get:
      summary: Get category-specific reading
      operationId: getCategoryReading
      tags:
        - Reading
      parameters:
        - name: chartId
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Chart ID
        - name: category
          in: path
          required: true
          schema:
            type: string
            enum: [summary, love, career, finances, health, timeline]
          description: Reading category
        - name: provider
          in: query
          required: false
          schema:
            type: string
            enum: [claude, deepseek, gemini, openai]
          description: Preferred AI provider (optional, uses configured default if not specified)
        - name: userId
          in: query
          required: false
          schema:
            type: string
          description: User ID for subscription check
      responses:
        '200':
          description: Reading generated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReadingResponse'
        '400':
          description: Invalid category
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Premium subscription required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Chart not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/reading/{chartId}/chat:
    post:
      summary: Ask a follow-up question
      operationId: askQuestion
      tags:
        - Reading
      parameters:
        - name: chartId
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Chart ID
        - name: provider
          in: query
          required: false
          schema:
            type: string
            enum: [claude, deepseek, gemini, openai]
          description: Preferred AI provider (optional, uses configured default if not specified)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChatRequest'
      responses:
        '200':
          description: Question answered
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChatResponse'
        '404':
          description: Chart not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/reading/{chartId}/cached:
    get:
      summary: Get cached readings for a chart
      operationId: getCachedReadings
      tags:
        - Reading
      parameters:
        - name: chartId
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Chart ID
      responses:
        '200':
          description: Cached readings list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CachedReadingsResponse'

  /api/reading/{chartId}/chat/history:
    get:
      summary: Get chat history for a chart
      operationId: getChatHistory
      tags:
        - Reading
      parameters:
        - name: chartId
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Chart ID
        - name: userId
          in: query
          required: false
          schema:
            type: string
          description: User ID
      responses:
        '200':
          description: Chat history
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChatHistoryResponse'
        '404':
          description: Chart not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    delete:
      summary: Clear chat history for a chart
      operationId: clearChatHistory
      tags:
        - Reading
      parameters:
        - name: chartId
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Chart ID
        - name: userId
          in: query
          required: false
          schema:
            type: string
          description: User ID
      responses:
        '200':
          description: Chat history cleared
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
        '404':
          description: Chart not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/ai/providers:
    get:
      summary: List available AI providers
      operationId: getAIProviders
      tags:
        - AI
      description: Returns a list of all configured AI providers and their current availability status
      responses:
        '200':
          description: List of AI providers
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AIProvidersResponse'

  /api/subscription/status:
    get:
      summary: Get subscription status
      operationId: getSubscriptionStatus
      tags:
        - Subscription
      parameters:
        - name: userId
          in: query
          required: false
          schema:
            type: string
          description: User ID (optional for authenticated requests)
      responses:
        '200':
          description: Subscription status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SubscriptionStatusResponse'

  /api/subscription/webhook:
    post:
      summary: RevenueCat webhook endpoint
      operationId: handleSubscriptionWebhook
      tags:
        - Subscription
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RevenueCatWebhookPayload'
      responses:
        '200':
          description: Webhook received
          content:
            application/json:
              schema:
                type: object
                properties:
                  received:
                    type: boolean
                  message:
                    type: string
        '400':
          description: Invalid webhook signature
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/subscription/question-usage:
    get:
      summary: Get question usage for a user
      operationId: getQuestionUsage
      tags:
        - Subscription
      parameters:
        - name: userId
          in: query
          required: false
          schema:
            type: string
          description: User ID
      responses:
        '200':
          description: Question usage info
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QuestionUsageResponse'

  # Affiliate Routes
  /api/affiliate/track/{code}:
    get:
      summary: Track affiliate link click
      operationId: trackAffiliateClick
      tags:
        - Affiliate
      parameters:
        - name: code
          in: path
          required: true
          schema:
            type: string
          description: Affiliate code
      responses:
        '200':
          description: Affiliate code valid
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AffiliateTrackResponse'
        '404':
          description: Affiliate code not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/affiliate/validate/{code}:
    get:
      summary: Validate affiliate code without tracking
      operationId: validateAffiliateCode
      tags:
        - Affiliate
      parameters:
        - name: code
          in: path
          required: true
          schema:
            type: string
          description: Affiliate code
      responses:
        '200':
          description: Affiliate code valid
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AffiliateValidateResponse'
        '404':
          description: Affiliate code not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/affiliate/apply:
    post:
      summary: Apply affiliate code during signup
      operationId: applyAffiliateCode
      tags:
        - Affiliate
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AffiliateApplyRequest'
      responses:
        '200':
          description: Affiliate code applied
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AffiliateApplyResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Affiliate code not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/affiliate/stats:
    get:
      summary: Get affiliate performance stats
      operationId: getAffiliateStats
      tags:
        - Affiliate
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Affiliate stats
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AffiliateStatsResponse'
        '401':
          description: Authentication required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Not an affiliate partner
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/affiliate/record-conversion:
    post:
      summary: Record affiliate conversion
      operationId: recordAffiliateConversion
      tags:
        - Affiliate
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - userId
              properties:
                userId:
                  type: string
                purchaseAmount:
                  type: number
      responses:
        '200':
          description: Conversion recorded
          content:
            application/json:
              schema:
                type: object
                properties:
                  recorded:
                    type: boolean
                  affiliateCode:
                    type: string
                  commission:
                    type: number

  # Admin Routes
  /api/admin/users:
    get:
      summary: List all users
      operationId: adminListUsers
      tags:
        - Admin
      security:
        - bearerAuth: []
      parameters:
        - name: role
          in: query
          schema:
            type: string
            enum: [user, developer, admin]
        - name: subscriptionStatus
          in: query
          schema:
            type: string
            enum: [free, trial, premium]
        - name: search
          in: query
          schema:
            type: string
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        '200':
          description: Users list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AdminUsersResponse'
        '401':
          description: Authentication required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Admin access required
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/admin/users/{id}:
    get:
      summary: Get user details
      operationId: adminGetUser
      tags:
        - Admin
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: User details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AdminUserDetailResponse'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/admin/users/{id}/grant-premium:
    post:
      summary: Grant premium access manually
      operationId: adminGrantPremium
      tags:
        - Admin
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GrantPremiumRequest'
      responses:
        '200':
          description: Premium granted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GrantPremiumResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/admin/users/{id}/set-role:
    post:
      summary: Set user role
      operationId: adminSetUserRole
      tags:
        - Admin
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SetRoleRequest'
      responses:
        '200':
          description: Role updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  userId:
                    type: string
                  role:
                    type: string

  /api/admin/affiliates:
    get:
      summary: List all affiliates
      operationId: adminListAffiliates
      tags:
        - Admin
      security:
        - bearerAuth: []
      parameters:
        - name: activeOnly
          in: query
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: Affiliates list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AdminAffiliatesResponse'
    post:
      summary: Create affiliate partner
      operationId: adminCreateAffiliate
      tags:
        - Admin
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateAffiliateRequest'
      responses:
        '201':
          description: Affiliate created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateAffiliateResponse'
        '400':
          description: Invalid request or code exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/admin/affiliates/{id}:
    patch:
      summary: Update affiliate partner
      operationId: adminUpdateAffiliate
      tags:
        - Admin
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateAffiliateRequest'
      responses:
        '200':
          description: Affiliate updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  affiliate:
                    $ref: '#/components/schemas/AffiliatePartner'

  /api/admin/affiliates/{id}/payout:
    post:
      summary: Record affiliate payout
      operationId: adminRecordAffiliatePayout
      tags:
        - Admin
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - amount
              properties:
                amount:
                  type: number
                  minimum: 0.01
      responses:
        '200':
          description: Payout recorded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PayoutResponse'
        '400':
          description: Invalid amount
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/admin/promo-codes:
    get:
      summary: List all promo codes
      operationId: adminListPromoCodes
      tags:
        - Admin
      security:
        - bearerAuth: []
      parameters:
        - name: activeOnly
          in: query
          schema:
            type: boolean
            default: false
      responses:
        '200':
          description: Promo codes list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AdminPromoCodesResponse'
    post:
      summary: Create promo code
      operationId: adminCreatePromoCode
      tags:
        - Admin
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreatePromoCodeRequest'
      responses:
        '201':
          description: Promo code created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreatePromoCodeResponse'
        '400':
          description: Invalid request or code exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/admin/promo-codes/{code}:
    delete:
      summary: Deactivate promo code
      operationId: adminDeactivatePromoCode
      tags:
        - Admin
      security:
        - bearerAuth: []
      parameters:
        - name: code
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Promo code deactivated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  code:
                    type: string
                  message:
                    type: string
        '404':
          description: Promo code not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/admin/stats:
    get:
      summary: Get admin dashboard stats
      operationId: adminGetStats
      tags:
        - Admin
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Dashboard stats
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AdminStatsResponse'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    # Auth Schemas
    RegisterRequest:
      type: object
      required:
        - name
        - email
        - password
      properties:
        name:
          type: string
          minLength: 2
          maxLength: 100
          example: John Doe
        email:
          type: string
          format: email
          example: john@example.com
        password:
          type: string
          minLength: 6
          maxLength: 100
          example: securePassword123

    LoginRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
          example: john@example.com
        password:
          type: string
          example: securePassword123

    AuthResponse:
      type: object
      properties:
        success:
          type: boolean
        message:
          type: string
        token:
          type: string
          description: JWT token
        user:
          $ref: '#/components/schemas/User'

    User:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        email:
          type: string
          format: email
        createdAt:
          type: string
          format: date-time

    UserResponse:
      type: object
      properties:
        success:
          type: boolean
        user:
          $ref: '#/components/schemas/User'

    # Chart Schemas
    ChartRequest:
      type: object
      required:
        - birthDate
        - birthTime
        - latitude
        - longitude
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 100
          example: 'John Doe'
          description: Name of the person (optional)
        birthDate:
          type: string
          pattern: '^\d{4}-\d{2}-\d{2}$'
          example: '1990-05-15'
          description: Birth date in YYYY-MM-DD format
        birthTime:
          type: string
          pattern: '^\d{2}:\d{2}$'
          example: '14:30'
          description: Birth time in HH:MM format (24-hour)
        place:
          type: string
          maxLength: 200
          example: 'New York, NY, USA'
          description: Birth place name (optional, for display)
        latitude:
          type: number
          minimum: -90
          maximum: 90
          example: 40.7128
        longitude:
          type: number
          minimum: -180
          maximum: 180
          example: -74.006
        timezone:
          type: string
          example: 'America/New_York'
          description: IANA timezone identifier

    ChartResponse:
      type: object
      properties:
        success:
          type: boolean
        chart:
          $ref: '#/components/schemas/BirthChart'

    BirthChart:
      type: object
      required:
        - id
        - birthDate
        - birthTime
        - latitude
        - longitude
        - timezone
        - ascendant
        - planets
        - houses
        - dashas
        - ayanamsa
        - ayanamsaName
        - calculatedAt
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
          description: Name of the person
        birthDate:
          type: string
          format: date-time
        birthTime:
          type: string
        place:
          type: string
          description: Birth place name
        latitude:
          type: number
        longitude:
          type: number
        timezone:
          type: string
        ascendant:
          $ref: '#/components/schemas/Planet'
        planets:
          type: array
          items:
            $ref: '#/components/schemas/Planet'
        houses:
          type: array
          items:
            $ref: '#/components/schemas/House'
        dashas:
          type: array
          items:
            $ref: '#/components/schemas/DashaPeriod'
        ayanamsa:
          type: number
          description: Ayanamsa value in degrees
        ayanamsaName:
          type: string
          example: Lahiri
        calculatedAt:
          type: string
          format: date-time

    Planet:
      type: object
      required:
        - name
        - sign
        - signIndex
        - degree
        - longitude
        - nakshatra
        - nakshatraPada
        - house
        - isRetrograde
      properties:
        name:
          type: string
          enum: [Sun, Moon, Mars, Mercury, Jupiter, Venus, Saturn, Rahu, Ketu]
        sign:
          type: string
          enum: [Aries, Taurus, Gemini, Cancer, Leo, Virgo, Libra, Scorpio, Sagittarius, Capricorn, Aquarius, Pisces]
        signIndex:
          type: integer
          minimum: 0
          maximum: 11
        degree:
          type: number
          minimum: 0
          maximum: 30
        longitude:
          type: number
          minimum: 0
          maximum: 360
        nakshatra:
          type: string
        nakshatraPada:
          type: integer
          minimum: 1
          maximum: 4
        house:
          type: integer
          minimum: 1
          maximum: 12
        isRetrograde:
          type: boolean

    House:
      type: object
      required:
        - number
        - sign
        - signIndex
        - degree
        - longitude
      properties:
        number:
          type: integer
          minimum: 1
          maximum: 12
        sign:
          type: string
        signIndex:
          type: integer
        degree:
          type: number
        longitude:
          type: number

    DashaPeriod:
      type: object
      required:
        - planet
        - startDate
        - endDate
        - level
      properties:
        planet:
          type: string
        startDate:
          type: string
          format: date-time
        endDate:
          type: string
          format: date-time
        level:
          type: string
          enum: [maha, antar, pratyantar]

    # Reading Schemas
    CategoriesResponse:
      type: object
      properties:
        success:
          type: boolean
        categories:
          type: array
          items:
            $ref: '#/components/schemas/ReadingCategory'
        userTier:
          type: string
          enum: [free, premium, pro]
        isPremium:
          type: boolean

    ReadingCategory:
      type: object
      properties:
        id:
          type: string
          enum: [summary, love, career, finances, health, timeline]
        name:
          type: string
        description:
          type: string
        accessLevel:
          type: string
          enum: [free, premium]
        isLocked:
          type: boolean

    ReadingResponse:
      type: object
      properties:
        success:
          type: boolean
        reading:
          $ref: '#/components/schemas/Reading'

    Reading:
      type: object
      required:
        - category
        - content
        - cached
        - chartId
        - generatedAt
      properties:
        category:
          type: string
        content:
          type: string
        cached:
          type: boolean
        chartId:
          type: string
          format: uuid
        generatedAt:
          type: string
          format: date-time
        provider:
          type: string
          description: AI provider used to generate the reading
          enum: [claude, deepseek, gemini, openai]

    ChatRequest:
      type: object
      required:
        - question
      properties:
        question:
          type: string
          minLength: 1
          maxLength: 500
        history:
          type: array
          items:
            $ref: '#/components/schemas/ChatMessageItem'
        userId:
          type: string
          description: User ID for tracking question quota

    ChatMessageItem:
      type: object
      properties:
        role:
          type: string
          enum: [user, assistant]
        content:
          type: string
        timestamp:
          type: string
          format: date-time

    ChatResponse:
      type: object
      properties:
        success:
          type: boolean
        response:
          type: string
        chartId:
          type: string
        timestamp:
          type: string
          format: date-time
        provider:
          type: string
          description: AI provider used to generate the response
          enum: [claude, deepseek, gemini, openai]
        questionsRemaining:
          type: integer
          description: Number of free questions remaining for the user

    QuestionQuotaResponse:
      type: object
      properties:
        success:
          type: boolean
        questionsUsed:
          type: integer
        questionsRemaining:
          type: integer
        limit:
          type: integer
        resetAt:
          type: string
          format: date-time

    ChatHistoryResponse:
      type: object
      properties:
        success:
          type: boolean
        chartId:
          type: string
        history:
          type: array
          items:
            $ref: '#/components/schemas/ChatMessageItem'
        messageCount:
          type: integer

    CachedReadingsResponse:
      type: object
      properties:
        success:
          type: boolean
        chartId:
          type: string
        cachedReadings:
          type: array
          items:
            type: object
            properties:
              category:
                type: string
              createdAt:
                type: string
                format: date-time
              hasContent:
                type: boolean

    # AI Schemas
    AIProvidersResponse:
      type: object
      properties:
        success:
          type: boolean
        providers:
          type: array
          items:
            $ref: '#/components/schemas/AIProviderInfo'
        defaultProvider:
          type: string
          description: The currently configured default provider
          enum: [claude, deepseek, gemini, openai]

    AIProviderInfo:
      type: object
      properties:
        name:
          type: string
          enum: [claude, deepseek, gemini, openai]
        available:
          type: boolean
          description: Whether this provider is currently available (API key configured)
        model:
          type: string
          description: The model being used by this provider

    # Subscription Schemas
    SubscriptionStatusResponse:
      type: object
      properties:
        success:
          type: boolean
        subscription:
          type: object
          properties:
            isPremium:
              type: boolean
            tier:
              type: string
              enum: [free, premium, pro]
            expiresAt:
              type: string
              format: date-time
              nullable: true
            provider:
              type: string
              nullable: true
              description: Subscription provider (revenuecat, stripe, manual) or null if free
            entitlements:
              type: array
              items:
                type: string
              description: List of entitlements (premium_access, unlimited_questions, all_readings)

    RevenueCatWebhookPayload:
      type: object
      properties:
        api_version:
          type: string
        event:
          type: object
          properties:
            type:
              type: string
              enum: [INITIAL_PURCHASE, RENEWAL, CANCELLATION, UNCANCELLATION, NON_RENEWING_PURCHASE, SUBSCRIPTION_PAUSED, EXPIRATION, BILLING_ISSUE, PRODUCT_CHANGE, TRANSFER]
            app_user_id:
              type: string
            original_app_user_id:
              type: string
            product_id:
              type: string
            entitlement_ids:
              type: array
              items:
                type: string
            expiration_at_ms:
              type: integer
            purchased_at_ms:
              type: integer
            environment:
              type: string
              enum: [SANDBOX, PRODUCTION]
            store:
              type: string
              enum: [APP_STORE, PLAY_STORE, STRIPE, PROMOTIONAL]

    QuestionUsageResponse:
      type: object
      properties:
        success:
          type: boolean
        usage:
          type: object
          properties:
            count:
              type: integer
            remaining:
              type: integer
            limit:
              type: integer
            resetAt:
              type: string
              format: date-time
            isPremium:
              type: boolean

    # Error Schema
    Error:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: string
        message:
          type: string
        path:
          type: string

    # Affiliate Schemas
    AffiliateTrackResponse:
      type: object
      properties:
        valid:
          type: boolean
        name:
          type: string
        discountPercent:
          type: integer
        trialDays:
          type: integer

    AffiliateValidateResponse:
      type: object
      properties:
        valid:
          type: boolean
        name:
          type: string
        discountPercent:
          type: integer
        trialDays:
          type: integer

    AffiliateApplyRequest:
      type: object
      required:
        - code
        - userId
      properties:
        code:
          type: string
        userId:
          type: string

    AffiliateApplyResponse:
      type: object
      properties:
        applied:
          type: boolean
        benefits:
          type: object
          properties:
            trialDays:
              type: integer
            trialEndsAt:
              type: string
              format: date-time
            discountPercent:
              type: integer
            affiliateName:
              type: string

    AffiliateStatsResponse:
      type: object
      properties:
        code:
          type: string
        name:
          type: string
        clicks:
          type: integer
        signups:
          type: integer
        conversions:
          type: integer
        conversionRate:
          type: string
        pendingPayout:
          type: number
        totalPaid:
          type: number
        discountPercent:
          type: integer
        commissionPercent:
          type: integer
        trialDays:
          type: integer
        isActive:
          type: boolean
        createdAt:
          type: string
          format: date-time

    AffiliatePartner:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        code:
          type: string
        discountPercent:
          type: integer
        commissionPercent:
          type: integer
        trialDays:
          type: integer
        isActive:
          type: boolean
        clicks:
          type: integer
        signups:
          type: integer
        conversions:
          type: integer
        pendingPayout:
          type: number
        totalPaid:
          type: number
        createdAt:
          type: string
          format: date-time

    # Admin Schemas
    AdminUsersResponse:
      type: object
      properties:
        users:
          type: array
          items:
            $ref: '#/components/schemas/AdminUserSummary'
        total:
          type: integer
        limit:
          type: integer
        offset:
          type: integer

    AdminUserSummary:
      type: object
      properties:
        id:
          type: string
          format: uuid
        email:
          type: string
        name:
          type: string
        role:
          type: string
          enum: [user, developer, admin]
        subscriptionStatus:
          type: string
          enum: [free, trial, premium]
        subscriptionExpiresAt:
          type: string
          format: date-time
          nullable: true
        trialEndsAt:
          type: string
          format: date-time
          nullable: true
        trialUsed:
          type: boolean
        referralCode:
          type: string
          nullable: true
        referredBy:
          type: string
          nullable: true
        questionsUsedThisMonth:
          type: integer
        createdAt:
          type: string
          format: date-time

    AdminUserDetailResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        email:
          type: string
        name:
          type: string
        role:
          type: string
        subscriptionStatus:
          type: string
        subscriptionExpiresAt:
          type: string
          format: date-time
          nullable: true
        trialStartedAt:
          type: string
          format: date-time
          nullable: true
        trialEndsAt:
          type: string
          format: date-time
          nullable: true
        trialUsed:
          type: boolean
        referralCode:
          type: string
          nullable: true
        referredBy:
          type: string
          nullable: true
        charts:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
              name:
                type: string
              createdAt:
                type: string
                format: date-time
        affiliatePartner:
          $ref: '#/components/schemas/AffiliatePartner'
        _count:
          type: object
          properties:
            charts:
              type: integer
            chatSessions:
              type: integer
        createdAt:
          type: string
          format: date-time

    GrantPremiumRequest:
      type: object
      required:
        - days
        - reason
      properties:
        days:
          type: integer
          minimum: 1
        reason:
          type: string
          minLength: 1

    GrantPremiumResponse:
      type: object
      properties:
        success:
          type: boolean
        userId:
          type: string
        expiresAt:
          type: string
          format: date-time
        days:
          type: integer
        reason:
          type: string

    SetRoleRequest:
      type: object
      required:
        - role
      properties:
        role:
          type: string
          enum: [user, developer, admin]

    AdminAffiliatesResponse:
      type: object
      properties:
        affiliates:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
              name:
                type: string
              code:
                type: string
              discountPercent:
                type: integer
              commissionPercent:
                type: integer
              trialDays:
                type: integer
              isActive:
                type: boolean
              clicks:
                type: integer
              signups:
                type: integer
              conversions:
                type: integer
              conversionRate:
                type: string
              pendingPayout:
                type: number
              totalPaid:
                type: number
              user:
                type: object
                nullable: true
                properties:
                  email:
                    type: string
                  name:
                    type: string
              createdAt:
                type: string
                format: date-time

    CreateAffiliateRequest:
      type: object
      required:
        - name
        - code
      properties:
        name:
          type: string
        code:
          type: string
        discountPercent:
          type: integer
          default: 0
        commissionPercent:
          type: integer
          default: 0
        trialDays:
          type: integer
          default: 7
        userId:
          type: string
          format: uuid

    CreateAffiliateResponse:
      type: object
      properties:
        success:
          type: boolean
        affiliate:
          type: object
          properties:
            id:
              type: string
            name:
              type: string
            code:
              type: string
            discountPercent:
              type: integer
            commissionPercent:
              type: integer
            trialDays:
              type: integer

    UpdateAffiliateRequest:
      type: object
      properties:
        name:
          type: string
        discountPercent:
          type: integer
        commissionPercent:
          type: integer
        trialDays:
          type: integer
        isActive:
          type: boolean

    PayoutResponse:
      type: object
      properties:
        success:
          type: boolean
        affiliateId:
          type: string
        amount:
          type: number
        newPendingPayout:
          type: number
        newTotalPaid:
          type: number

    AdminPromoCodesResponse:
      type: object
      properties:
        promoCodes:
          type: array
          items:
            $ref: '#/components/schemas/PromoCodeInfo'

    PromoCodeInfo:
      type: object
      properties:
        id:
          type: string
          format: uuid
        code:
          type: string
        type:
          type: string
          enum: [trial_extension, discount, full_access]
        value:
          type: integer
        isValid:
          type: boolean

    CreatePromoCodeRequest:
      type: object
      required:
        - code
        - type
        - value
      properties:
        code:
          type: string
        type:
          type: string
          enum: [trial_extension, discount, full_access]
        value:
          type: integer
        maxUses:
          type: integer
          nullable: true
        expiresAt:
          type: string
          format: date-time
          nullable: true

    CreatePromoCodeResponse:
      type: object
      properties:
        success:
          type: boolean
        promoCode:
          $ref: '#/components/schemas/PromoCodeInfo'

    AdminStatsResponse:
      type: object
      properties:
        users:
          type: object
          properties:
            total:
              type: integer
            newThisMonth:
              type: integer
            premium:
              type: integer
            trial:
              type: integer
            free:
              type: integer
        content:
          type: object
          properties:
            totalCharts:
              type: integer
        affiliates:
          type: object
          properties:
            totalClicks:
              type: integer
            totalSignups:
              type: integer
            totalConversions:
              type: integer
            pendingPayouts:
              type: number
        conversion:
          type: object
          properties:
            trialToSubscription:
              type: string
