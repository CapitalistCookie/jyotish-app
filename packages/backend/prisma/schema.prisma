// Prisma schema for Jyotish Backend

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// User model with subscription fields
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String?
  password  String   // Hashed password

  // Subscription fields
  subscriptionStatus    String    @default("free") // free, trial, premium, admin
  subscriptionExpiresAt DateTime?
  subscriptionProvider  String?   // revenuecat, stripe, manual
  revenuecatId          String?   @unique

  // Trial fields
  trialStartedAt DateTime?
  trialEndsAt    DateTime?
  trialUsed      Boolean   @default(false)

  // Affiliate fields
  referralCode   String?   @unique // Their code to share
  referredBy     String?   // Code they signed up with
  referredByUser User?     @relation("Referrals", fields: [referredBy], references: [referralCode])
  referrals      User[]    @relation("Referrals")

  // Role-based access
  role           String    @default("user") // user, developer, admin

  // Question usage tracking
  questionsUsedThisMonth Int       @default(0)
  questionResetDate      DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  charts            Chart[]
  chatSessions      ChatSession[]
  affiliatePartner  AffiliatePartner?

  @@map("users")
}

// Birth chart storage
model Chart {
  id        String   @id @default(uuid())
  userId    String?
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  // Birth details
  name            String?
  birthDate       DateTime
  birthTime       String    // HH:MM format
  place           String?
  latitude        Float
  longitude       Float
  timezone        String    @default("UTC")

  // Calculated chart data (stored as JSON)
  chartData       Json      // Full chart including planets, houses, dashas

  // Cached readings
  cachedReadings  CachedReading[]
  chatSessions    ChatSession[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("charts")
}

// Cached AI readings
model CachedReading {
  id        String   @id @default(uuid())
  chartId   String
  chart     Chart    @relation(fields: [chartId], references: [id], onDelete: Cascade)

  category  String   // summary, love, career, finances, health, timeline
  content   String   @db.Text
  provider  String   // AI provider used

  createdAt DateTime @default(now())
  expiresAt DateTime?

  @@unique([chartId, category])
  @@map("cached_readings")
}

// Chat session for follow-up questions
model ChatSession {
  id        String   @id @default(uuid())
  chartId   String
  chart     Chart    @relation(fields: [chartId], references: [id], onDelete: Cascade)
  userId    String?
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  messages  ChatMessage[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("chat_sessions")
}

// Individual chat messages
model ChatMessage {
  id          String      @id @default(uuid())
  sessionId   String
  session     ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  role        String      // user, assistant
  content     String      @db.Text

  createdAt   DateTime    @default(now())

  @@map("chat_messages")
}

// Subscription events log (for webhook processing)
model SubscriptionEvent {
  id            String   @id @default(uuid())
  userId        String
  eventType     String   // INITIAL_PURCHASE, RENEWAL, CANCELLATION, etc.
  productId     String?
  provider      String   // revenuecat, stripe
  environment   String?  // SANDBOX, PRODUCTION
  rawPayload    Json?    // Full webhook payload

  processedAt   DateTime @default(now())

  @@map("subscription_events")
}

// Affiliate partner for referral program
model AffiliatePartner {
  id                String   @id @default(uuid())
  name              String   // "CosmicInfluencer"
  code              String   @unique // "COSMIC20"
  discountPercent   Int      @default(0) // 20 = 20% off
  commissionPercent Int      @default(0) // 30 = 30% commission
  trialDays         Int      @default(7) // Extended trial for their audience
  isActive          Boolean  @default(true)

  // Tracking
  clicks      Int @default(0)
  signups     Int @default(0)
  conversions Int @default(0)

  // Payout
  pendingPayout Decimal @default(0)
  totalPaid     Decimal @default(0)

  // Relations
  userId String? @unique
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("affiliate_partners")
}

// Promotional codes
model PromoCode {
  id        String    @id @default(uuid())
  code      String    @unique // "LAUNCH50"
  type      String    // "trial_extension", "discount", "full_access"
  value     Int       // days for trial, percent for discount
  maxUses   Int?      // null = unlimited
  usedCount Int       @default(0)
  expiresAt DateTime?
  isActive  Boolean   @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("promo_codes")
}
